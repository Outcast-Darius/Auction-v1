<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bidding history</title>

<link rel="stylesheet" href="style.css">

</head>
<body>
    <header>
    <nav>
    <li><a href="index.html">Home</a></li>
    <li><a href="AUCTION.HTML">Auction</a></li>
    <li id="reports"><a href="REPORTS.HTML">Reports</a></li>
    <!--<li><a href="BIDDERS.HTML">Bidders</a></li>-->
    <li><a href="ADVERTISE.HTML">Advertise</a></li>
    </nav>
    
    <div id="sign">
    <a href="PROFILE.HTML"><div id="accountImage"><!-- profile image--> </div></a>
    <button id="signIn"><a href="LOGIN.HTML">Sign In</a></button>
    </div>    
    </header>
    
    <section id="history-section">
    <div class="report" id="history"></div><!--bidding history will be shown here-->
    </section>
    
    <footer>
    <div id="column1">
    <a href="ABOUT.HTML">About us</a><br>
    <a href="SETTINGS.HTML">Settings</a>
    </div>
    <div id="column4">
    <li>P.O.BOX 281</li>
    <li>Malakisi</li>
    <li>Nairobi-kenya</li>    
    </div>
    <div id="column2">
    <h4>Created By </h4>
    <p id="creator">Outcast DHO</p>
    <P id="rights">All Rights Reserved</P>
    <p id="copy">Copyright &copy;</p>
    </div>
    <div id="column3">
    <li><a href="#">x</a></li>    
    <li><a href="#">Facebook</a></li>    
    <li><a href="#">Instagram</a></li>    
    <li><a href="#">LinkedIn</a></li>    
    <li><a href="#">Whatsapp</a></li>    
    <li><a href="#">Telegram</a></li>    
    <li><a href="#">Pinterest</a></li>    
    <li><a href="#">GitHub</a></li>    
    </div>
    </footer>

<script type="module">
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";    
    import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection,getDoc, doc, setDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js"
    
    const firebaseConfig = {
        apiKey: "AIzaSyC6h2xegIwjeAHQVsPNyD-LI5JvBgrmS-c",
        authDomain: "auction-8a92a.firebaseapp.com",
        projectId: "auction-8a92a",
        storageBucket: "auction-8a92a.firebasestorage.app",
        messagingSenderId: "414092650508",
        appId: "1:414092650508:web:87420c9788157020262629"
    };
    
    const app = initializeApp(firebaseConfig);

    const db = getFirestore(app); 
    const auth = getAuth(app);   
    window.db=db;    

async function getHistory() {
    
    const historyCollectionRef = collection(db, "history"); 
    const histDisplay = document.getElementById("history");

    histDisplay.innerHTML = `
        <table id="bidding-history">
            <thead>
                <caption>Bidding History</caption>
                <tr>
                    <th>#</th>
                    <th>Item Name</th>
                    <th>Bid Price</th>
                    <th>Date</th>
                    <th>Status</th>
                </tr>
            </thead> 
            <tbody id="history-body">
                </tbody>
        </table>`;
        
    const tableBody = document.getElementById("history-body");

    try {        
        const querySnapshot = await getDocs(historyCollectionRef); 
        
        if (querySnapshot.empty) {
            histDisplay.innerHTML = "No history Yet!";
            histDisplay.style.color="red"
            console.log("No documents found in the history collection.");
            return; 
        }
        let rank=1;
        
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const bidderdate=data.BidDate.toDate().toLocaleDateString(
            
                'en-US',{
                    year:'numeric',
                    month:'numeric',
                    day:'numeric',
            
            });
            
            
            const newRow = `
                <tr>
                    <td>${rank}</td>
                    <td>${data.ItemName || 'N/A'}</td>
                    <td>ksh ${data.BidPrice || /*? data.BidPrice.toFixed(2) :*/ 'N/A'}</td>
                    <td>${bidderdate  || data.BidDate}</td>
                    <td>${data.Status || 'N/A'}</td>
                </tr>`;
            rank++;
            tableBody.innerHTML += newRow; 
        });
        
    } catch (e) {        
        console.error("Error reading data:", e);
        histDisplay.innerHTML = `Error reading data: ${e.message}`;
    }
}
getHistory();
    
    onAuthStateChanged(auth, async(user)=>{
        const signInDiv=document.getElementById("signIn");
        const profileImage=document.getElementById("accountImage");
        
        if(user){
            console.log("User is signed in:",user.uid);
            profileImage.style.display="block";
            if(signInDiv){
                signInDiv.style.display="none";
                
            }
            
        try{    
            const userRef=doc(db,"users",user.uid);
            const userSnap=await getDoc(userRef);
            
            if(userSnap.exists()){
                const userData=userSnap.data();
                if(profileImage){
                    profileImage.innerHTML=`<img src="${userData.ProfilePhoto || 'image4.jpg' }" alt="" >`;
                }
            else{
                console.log("No user Photo found");
            }
            }}
        catch(e){
            console.error("Error fetching user data:", e);
        }    
        }else{
            console.log("No user is signed in.");
            if(signInDiv){
                signInDiv.style.display="block";
                profileImage.style.display="none";
            }
        }   
            
            
    });
    
    
    
    
    
    
    
    
    </script>
</body>
</html>