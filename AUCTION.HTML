<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>auction/bidding page</title>

<link rel="stylesheet" href="style.css">


</head>
<body>
    
    <header>
    <nav>
    <li><a href="index.html">Home</a></li>
    <li><a href="AUCTION.HTML">Auction</a></li>
    <li id="reports"><a href="REPORTS.HTML">Reports</a></li>
    <li><a href="ADVERTISE.HTML">Advertise</a></li>
    <!--<li><a href="BID.HTML">Bids</a></li>-->
    </nav>
    
    <div id="sign">
    <a href="PROFILE.HTML"><div id="accountImage"><!-- profile image--> </div></a>
    <button id="signIn"><a href="LOGIN.HTML">Sign In</a></button>
    </div>    
    </header>
    
    <div class="animationContainer" id="anime">
    <div id="animation"><!-- changing image will be injected using css keyframes--></div>
    </div>
    
    <section class="auctionProducts">
    <div class="item-container" id="item"></div><!-- products will be injected using javascript-->    
    </section>
    
    <footer>
    <div id="column1">
    <a href="ABOUT.HTML">About us</a><br>
    <a href="SETTINGS.HTML">Settings</a>
    </div>
    <div id="column4">
    <li>P.O.BOX 281</li>
    <li>Malakisi</li>
    <li>Nairobi-kenya</li>    
    </div>
    <div id="column2">
    <h4>Created By </h4>
    <p id="creator">Outcast DHO</p>
    <P id="rights">All Rights Reserved</P>
    <p id="copy">Copyright &copy;</p>
    </div>
    <div id="column3">
    <li><a href="#">x</a></li>    
    <li><a href="#">Facebook</a></li>    
    <li><a href="#">Instagram</a></li>    
    <li><a href="#">LinkedIn</a></li>    
    <li><a href="#">Whatsapp</a></li>    
    <li><a href="#">Telegram</a></li>    
    <li><a href="#">Pinterest</a></li>    
    <li><a href="#">GitHub</a></li>    
    </div>
    </footer>
    
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";    
    import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDocs,getDoc,query,where,orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js"
    
    const firebaseConfig = {
        apiKey: "AIzaSyC6h2xegIwjeAHQVsPNyD-LI5JvBgrmS-c",
        authDomain: "auction-8a92a.firebaseapp.com",
        projectId: "auction-8a92a",
        storageBucket: "auction-8a92a.firebasestorage.app",
        messagingSenderId: "414092650508",
        appId: "1:414092650508:web:87420c9788157020262629"
    };
    
    const app = initializeApp(firebaseConfig);

    const db = getFirestore(app); 
    const auth = getAuth(app);   
    window.db=db;     
    
    window.bidItem=async function (itemId, itemName, itemLBP,itemDescription,auctioneerName,userId) {    
    const user=auth.currentUser;
    
    if(!user){
        alert("Please sign in first");    
    return;
    }
    const poster=doc(db,"items",itemId);
    const post=await getDoc(poster);
    const auctioneer=post.data()
    
    if(!post.exists()){
        alert("Auctioneer not found");
        return
    }
    
    
    try{
    const amount=itemLBP;    
    
    const PosterId=auctioneer.AuctioneerId;
    const currentItemData = [{
        id: itemId,
        name: itemName,
        LBP: itemLBP,
        description: itemDescription,
        AuctioneerId:PosterId,
        Auctioneer:auctioneerName
    }];
    
    
    localStorage.setItem("Items", JSON.stringify(currentItemData));
    localStorage.setItem("amount", JSON.stringify(amount));
    console.log("Item selected for bidding:", currentItemData);
    window.location.href="BID.HTML";
    
    }
    catch (e){
    console.error("Error reading data:", e);
    alert("an error occured reading data");
    
    }
    
    }
    
    
    async function displayBidItems(){ 
    const item=document.getElementById("item");
    const itemList=collection(db,"items");
    item.innerHTML="";
    
    if(!item)return
        item.innerHTML="Loading items..."
    
    try{
    const items=await getDocs(itemList);
    /*const now=new Date();
    const presentItems=query(
        itemsCollectionRef,where("ClosingDate",">",now),
        orderBy("ClosingDate","asc")
    
    );*/
    
    
    if(!items.empty){
        let allCards="" 
                
        items.forEach((doc)=>{
            const records=doc.data();
            const itemId = doc.id;
            const closingDate=new Date(records.ClosingDate);
            const today=new Date();
            const status=records.Status;
            
            if(status==="won"){
                console.log("Skipping execution, item won ");
                return;
            }
            
            
            if(closingDate<today || !(closingDate.getTime())){
                console.log("Skipping execution, invalid or expired date");
                return;
            }
            
            const auctioneerName=records.Auctioneer ;
            const description=(records.Description).replace(/'/g,"\\'");
            const itemName=(records.ItemName).replace(/\+/g,"%2B'");
            
            const card=`<div class="card">
            <img src="${records.Photo || 'image5.jpg' }" >
            <p id="ItemName">${itemName}</p>
            <p><span id="low">L.B.P </span>Ksh <span id="LBP">${records.LBP}</span></p>
            <p id="desc">${description}</p>
            <p id="timeleft"></p>
            <h5 >Closing <span id="lastdate">${records.ClosingDate}</span></h5>
            <p id="pp">Posted by: <span id="posted">${records.Auctioneer}</span></p>
            
            <button id="bid" onclick="bidItem('${itemId}','${records.ItemName}','${records.LBP}','${records.Description}','${records.Auctioneer}','${records.AuctioneerId}')">BID</button>
            </div>
            `;
        
        allCards +=card;
        });
        item.innerHTML=allCards;
    }
    else{
        item.innerHTML="No records Found."
    
    }
    }
    catch (e){
    console.error("Error reading data:", e);
    item.innerHTML = `Error reading data: ${e.message}`;
    
    }
    
    };
    displayBidItems();
    
    onAuthStateChanged(auth, async(user)=>{
        const signInDiv=document.getElementById("signIn");
        const profileImage=document.getElementById("accountImage");
        
        if(user){
            console.log("User is signed in:",user.uid);
            profileImage.style.display="block";
            
            
            if(signInDiv){
                signInDiv.style.display="none";                
            }
            
        try{    
            const userRef=doc(db,"users",user.uid);
            const userSnap=await getDoc(userRef);
            
            if(userSnap.exists()){
                const userData=userSnap.data();
                if(profileImage){
                    profileImage.innerHTML=`<img src="${userData.ProfilePhoto || 'image4.jpg'}" alt="" >`;
                }
            else{
                console.log("No user Photo found");
            }
            }}
        catch(e){
            console.error("Error fetching user data:", e);
        }    
        }else{
            console.log("No user is signed in.");
            if(signInDiv){
                signInDiv.style.display="block";
                profileImage.style.display="none";
            }
        }   
            
            
    });
    
    
    </script>
    
    
</body>
</html>