<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>profil/account center</title>

<link rel="stylesheet" href="style.css">

</head>
<body>
    <header>
    
    <nav>
    <li><a href="index.html">Home</a></li>
    <li><a href="AUCTION.HTML">Auction</a></li>
    <li id="reports"><a href="REPORTS.HTML">Reports</a></li>
    <li><a href="BIDDERS.HTML">Bidders</a></li>
    
    </nav>
    
    <div id="sign">
    <a href="PROFILE.HTML"><div id="accountImage"><!-- profile image--> </div></a>
    <!--<button id="signIn">Sign In</button>-->
    </div>    
    </header>
    
    <section id="profileSection">
    <form action="" method="post" id="profile-form">
        <h2 id="greet">Hello There</h2>
        <div class="profile" id="profile"></div>
        <p id="username">Name</p>
        <p id="succesBid">Succesfull Bids <span id="bids">0</span> </p>
        <a href="MYCARD.HTML" id="cardLink" title="View O_Card details " >O_Card</a><br>
        <button id="logout" onclick="logout()">Log Out</button>
        
    </form>
    </section>
    
    <footer>
    <div id="column1">
    <a href="ABOUT.HTML">About us</a><br>
    <a href="SETTINGS.HTML">Settings</a>
    </div>
    <div id="column4">
    <li>P.O.BOX 281</li>
    <li>Malakisi</li>
    <li>Nairobi-kenya</li>    
    </div>
    <div id="column2">
    <h4>Created By </h4>
    <p id="creator">Outcast DHO</p>
    <P id="rights">All Rights Reserved</P>
    <p id="copy">Copyright &copy;</p>
    </div>
    <div id="column3">
    <li><a href="#">x</a></li>    
    <li><a href="#">Facebook</a></li>    
    <li><a href="#">Instagram</a></li>    
    <li><a href="#">LinkedIn</a></li>    
    <li><a href="#">Whatsapp</a></li>    
    <li><a href="#">Telegram</a></li>    
    <li><a href="#">Pinterest</a></li>    
    <li><a href="#">GitHub</a></li>    
    </div>
    </footer>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";    
    import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js"
    
    const firebaseConfig = {
        apiKey: "AIzaSyC6h2xegIwjeAHQVsPNyD-LI5JvBgrmS-c",
        authDomain: "auction-8a92a.firebaseapp.com",
        projectId: "auction-8a92a",
        storageBucket: "auction-8a92a.firebasestorage.app",
        messagingSenderId: "414092650508",
        appId: "1:414092650508:web:87420c9788157020262629"
    };
    
    const app = initializeApp(firebaseConfig);

    const db = getFirestore(app); 
    const auth = getAuth(app);   
    window.db=db;
    
    
    
    async function displayDetails(userId) {
    
    const nameElement = document.getElementById("username");
    const photoElement = document.getElementById("profile");
    const bidsElement = document.getElementById("bids");
    if(!userId){    
        
        return;
        }
        
        
    if (!nameElement || !photoElement || !bidsElement) {
        console.error("One or more target DOM elements (username, profile, bids) not found.");
        return; 
    }
    const detailsRef = doc(db, "users", userId);
    
    try {
        
        const record = await getDoc(detailsRef);
        
        if (record.exists()) {
            const displayData = record.data();
            const userName=displayData.username;
            
            nameElement.textContent = displayData.Username || "N/A"; 
            bidsElement.textContent = displayData.successBids || "0";
            photoElement.innerHTML=`<img src="${displayData.ProfilePhoto || 'image4.jpg'}">`;
            
            photoElement.src = displayData['profile-pic'] || "logo.jpg"; 
            photoElement.alt = `${displayData.username}'s Profile Photo`;
            
            console.log(`Details displayed for user: ${displayData.username}`);
            
        } else {
            
            console.log(`No record found for user: ${username}`);
            bidsElement.textContent = "00";
            photoElement.style.background="aliceblue";
            photoElement.alt = "profile Photo"; // Set alt text
            nameElement.textContent = username || "New User"; 
        }
    } catch (e) {
        console.error("Error reading data:", e);
        
        nameElement.textContent = `Error reading data.`;
        bidsElement.textContent = "N/A";
    }
    }
    
    onAuthStateChanged(auth, async(user)=>{
    if(user){
        console.log("User logged in.");
        displayDetails(user.uid);
        
        }
    else{
        console.log("User is logged out.");
        displayDetails(null);
        
    }
    
    });
    
    
    
    function greeting(){
    const greetText=document.getElementById("greet");
    const d=new Date();
    const timeNow=d.getHours();
    if(timeNow<12 && timeNow>3){
        greetText.innerHTML="Good Morning";
        greetText.style.color="orangered"
        
    }
    else if(timeNow>=12 && timeNow<16){
        greetText.innerHTML="Good Afternoon";
        greetText.style.color="gold"
    
    }
    else if(timeNow>=16 && timeNow<=23){
        greetText.innerHTML="Good Evening";
        greetText.style.color="yellow"
    
    }
    else{
        greetText.innerHTML="Nice Midnight";
        greetText.style.color=" navy";
        }
    }
    greeting();
    
    onAuthStateChanged(auth, async(user)=>{
        const signInDiv=document.getElementById("signIn");
        const profileImage=document.getElementById("accountImage");
        
        if(user){
            console.log("User is signed in:",user.uid);
            profileImage.style.display="block";
            
            
            if(signInDiv){
                signInDiv.style.display="none";
                
            }
            
        try{    
            const userRef=doc(db,"users",user.uid);
            const userSnap=await getDoc(userRef);
            
            if(userSnap.exists()){
                const userData=userSnap.data();
                if(profileImage){
                    profileImage.innerHTML=`<img src="${userData.ProfilePhoto  || 'image4.jpg'}" alt="Profile Image" >`;
                }
            else{
                console.log("No user Photo found");
            }
            }}
        catch(e){
            console.error("Error fetching user data:", e);
        }    
        }else{
            console.log("No user is signed in.");
            if(signInDiv){
                signInDiv.style.display="block";
                profileImage.style.display="none";
            }
        }   
            
            
    });
    async function logout(){
        try{
            await signOut (auth);
            alert("You have been logged out successfully.");
            window.location.href="index.html";
        }catch(error){
            console.error("Logout Error:", error);
            alert("Error logging out. Please try again.");
        }
    }
    document.getElementById("logout").addEventListener("click",(e)=>{
        e.preventDefault();
        logout();
    });
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    </script>
</body>
</html>