<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bids</title>

<link rel="stylesheet" href="style.css">

</head>
<body>
     <header>
    <nav>
    <li><a href="index.html">Home</a></li>
    <li><a href="AUCTION.HTML">Auction</a></li>
    <li id="reports"><a href="REPORTS.HTML">Reports</a></li>
    <li><a href="BIDDERS.HTML">Bidders</a></li>    
    </nav>
    
    <div id="sign">
    <a href="PROFILE.HTML"><div id="accountImage"><!-- profile image--> </div></a>
    <button id="signIn"><a href="LOGIN.HTML">Sign In</a></button>
    </div>    
    </header>
    
    <section class="bidTable" id="bidTable">
    <div class="biditem"></div><!--item selected for bidding will be displayed here -->        
        
    </section>
    
    <footer>
    <div id="column1">
    <a href="ABOUT.HTML">About us</a><br>
    <a href="SETTINGS.HTML">Settings</a>
    </div>
    <div id="column4">
    <li>P.O.BOX 281</li>
    <li>Malakisi</li>
    <li>Nairobi-kenya</li>    
    </div>
    <div id="column2">
    <h4>Created By </h4>
    <p id="creator">Outcast DHO</p>
    <P id="rights">All Rights Reserved</P>
    <p id="copy">Copyright &copy;</p>
    </div>
    <div id="column3">
    <li><a href="#">x</a></li>    
    <li><a href="#">Facebook</a></li>    
    <li><a href="#">Instagram</a></li>    
    <li><a href="#">LinkedIn</a></li>    
    <li><a href="#">Whatsapp</a></li>    
    <li><a href="#">Telegram</a></li>    
    <li><a href="#">Pinterest</a></li>    
    <li><a href="#">GitHub</a></li>    
    </div>    
    </footer>    
    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";    
    import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc,getDoc, getDocs,addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js"
    
    const firebaseConfig = {
        apiKey: "AIzaSyC6h2xegIwjeAHQVsPNyD-LI5JvBgrmS-c",
        authDomain: "auction-8a92a.firebaseapp.com",
        projectId: "auction-8a92a",
        storageBucket: "auction-8a92a.firebasestorage.app",
        messagingSenderId: "414092650508",
        appId: "1:414092650508:web:87420c9788157020262629"
    };
    
    const app = initializeApp(firebaseConfig);

    const db = getFirestore(app); 
    const auth = getAuth(app);   
    window.db=db;
    
    async function getItems(){    
    const bidTable=document.getElementById("bidTable");    
    const button=document.getElementById("placeBid");    
    
    
    try{
    const itemList=JSON.parse(localStorage.getItem("Items")) || [];
    
    bidTable.innerHTML=`
    <table><thead>
        <tr><th>Item Name</th>
            <th>LBP <sub>(ksh)</sub></th>
            <th>Description</th>
        </tr>
    <tbody id="tableBody"></tbody>
    </table>
    <br>
        <div id="amounting">
        <label for="bidamount">Bid Amount : </label>
        <input type="text" id="bidamount" placeholder="your bidding amount">
        </div>
        
        <button id="placeBid" onclick="payBid()">Place Bid</button>
        
    `;
    
    if(itemList.length>0){
        const tableBody=document.getElementById("tableBody");    
        tableBody.innerHTML=`
            <tr>
            <td>${itemList[0].name}</td>
            <td>${itemList[0].LBP}</td>
            <td>${itemList[0].description}</td>
            <tr>
        `;
        
        }
    else{
        bidTable.innerHTML="No records yet "
        bidTable.style.display="none";
    }
    }
    catch(e){
    console.error("Error reading data:", e);
    bidTable.innerHTML = `Error reading data: ${e.message}`;
    
    
    }
    };
    getItems();
    

let activeUserId = null;

window.payBid = async function () {
    // Instead of taking userId as a parameter, use the global variable
    if (!activeUserId) {
        console.error("payBid Error: activeUserId is still null.");
        alert("Please wait for your profile to load or sign in again.");
        return;
    }

    const items = JSON.parse(localStorage.getItem("Items"));
    const amount = JSON.parse(localStorage.getItem("amount"));
    const amountBid=document.getElementById("bidamount").value;

    if (!items || !items[0]) {
        alert("Item data missing. Please select an item again.");
        return;
    }

    const item = items[0];
    const lbp = parseFloat(item.LBP);
    const poster=items[0].AuctioneerId;
    
    try {
       
        const userRef = doc(db, "users", activeUserId); 
        const posterRef = doc(db, "items", activeUserId); 
        const userSnap = await getDoc(userRef);
        
        if (!userSnap.exists()) {
            alert("User profile not found. Please complete your registration.");
            return;
        }
        
        
        const users = userSnap.data();
        
        if (amount >= lbp) {
            const bidding = {
                ItemName: item.name,
                BidPrice: amountBid,
                Status: "pending",
                BidDate: new Date(),
                BidderName: users.Username || "Bidder",
                BidderUID: activeUserId,
                AuctioneerUID: poster  || "" ,
                Status:"pending" 
            };

            await addDoc(collection(db, "bidders"), bidding);
            await addDoc(collection(db, "history"), { ...bidding, Type: "Bid sent" });

            alert("Bid Placed Successfully");
            localStorage.removeItem("Items");
            localStorage.removeItem("amount");
            window.location.href = "REPORTS.HTML";
        } else {
            alert("Bid must be at least Ksh " + lbp);
        }
    } catch (e) {
        console.error("Firestore Error:", e);
        alert("Error: " + e.message);
    }
};


const postButton = document.getElementById("post-advert");
if (postButton) {
    postButton.addEventListener("click", (e) => {
        e.preventDefault();
        window.payBid();
    });
}

onAuthStateChanged(auth, async (user) => {
    const profileImage = document.getElementById("accountImage");
    const signIn = document.getElementById("signIn");

    if (user) {
        console.log("User logged in successfully:", user.uid);
        activeUserId = user.uid; 
        
        if (profileImage) profileImage.style.display = "block";
        if (signIn) signIn.style.display = "none";
    } else {
        activeUserId = null; 
        if (profileImage) profileImage.style.display = "none";
        if (signIn) signIn.style.display = "block";
    }
});
    
    
    
    
    
    
    
    
    
    
    
    </script>
</body>
</html>